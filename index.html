<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦æ ¡ã®è‘—ä½œæ¨© & ãƒ„ãƒ¼ãƒ«</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-12">

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-md">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center gap-2">
                <i data-lucide="school" class="w-8 h-8"></i>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">å­¦æ ¡ã®è‘—ä½œæ¨©ã‚¬ã‚¤ãƒ‰ & ãƒ„ãƒ¼ãƒ«</h1>
                    <p class="text-xs md:text-sm text-indigo-200">æ•™å“¡ãƒ»ç”Ÿå¾’ã®ãŸã‚ã®åˆ¤æ–­ã‚µãƒãƒ¼ãƒˆ</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-4xl mx-auto flex">
            <button onclick="setAppMode('checker')" id="tab-checker" class="flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-indigo-600 border-b-4 border-indigo-600 bg-indigo-50">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                Yes/No è¨ºæ–­
            </button>
            <button onclick="setAppMode('citation')" id="tab-citation" class="flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-slate-500 hover:bg-slate-50">
                <i data-lucide="book" class="w-5 h-5"></i>
                å‚è€ƒæ–‡çŒ®ã®æ›¸ãæ–¹
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="max-w-4xl mx-auto p-4 md:p-6 min-h-[60vh]">
        <!-- JSã§ã“ã“ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æç”» -->
    </main>

    <!-- Footer -->
    <footer class="max-w-4xl mx-auto p-4 text-center text-slate-400 text-xs mt-8 pb-12 border-t border-slate-200">
        <p>&copy; 2025 Copyright Checker for Schools</p>
        <p>å‚è€ƒè³‡æ–™: æ–‡åŒ–åºã€Œè‘—ä½œæ¨©ãƒ†ã‚­ã‚¹ãƒˆã€ / SARTRASé‹ç”¨æŒ‡é‡ / JASRACå­¦æ ¡æ•™è‚²åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</p>
    </footer>

    <!-- JavaScript Application Logic -->
    <script>
        // ==========================================
        // State (çŠ¶æ…‹ç®¡ç†)
        // ==========================================
        const state = {
            appMode: 'checker', // 'checker' | 'citation'
            
            // Checker State
            userType: null, // 'teacher' | 'student'
            scene: null,
            history: [],
            currentQuestionId: null,
            result: null,

            // Citation State
            citationType: 'book', // 'book' | 'web' | 'article'
            citationData: {
                author: '',
                title: '',
                publisher: '',
                year: '',
                url: '',
                accessDate: ''
            }
        };

        // ==========================================
        // Data Definitions
        // ==========================================
        const scenes = [
            {
                id: 'class',
                title: 'æˆæ¥­ãƒ»ã‚¯ãƒ©ã‚¹æ´»å‹•',
                icon: 'book-open',
                color: 'text-blue-500',
                description: 'ãƒ—ãƒªãƒ³ãƒˆé…å¸ƒã€ã‚¹ãƒ©ã‚¤ãƒ‰æç¤ºã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é…ä¿¡ãªã©',
                startQuestion: 'q_class_1'
            },
            {
                id: 'event',
                title: 'æ–‡åŒ–ç¥­ãƒ»éƒ¨æ´»å‹•',
                icon: 'music',
                color: 'text-pink-500',
                description: 'æ¼”åŠ‡ã€æ¼”å¥ã€ãƒ€ãƒ³ã‚¹ã€æ˜ ç”»ä¸Šæ˜ ãªã©',
                startQuestion: 'q_event_1'
            },
            {
                id: 'creative',
                title: 'ãƒ¬ãƒãƒ¼ãƒˆãƒ»ä½œå“åˆ¶ä½œ',
                icon: 'pen-tool',
                color: 'text-green-500',
                description: 'å¼•ç”¨ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®å…¬é–‹ã€ãƒã‚¹ã‚¿ãƒ¼ä½œæˆãªã©',
                startQuestion: 'q_creative_1'
            }
        ];

        const data = {
            // --- æˆæ¥­ã‚·ãƒ¼ãƒ³ ---
            q_class_1: {
                text: 'ãã®åˆ©ç”¨ã¯ã€å­¦æ ¡ã®æ•™è‚²èª²ç¨‹ä¸Šã®ã€Œæˆæ¥­ã€ï¼ˆéƒ¨æ´»å‹•ã‚„å­¦æ ¡è¡Œäº‹å«ã‚€ï¼‰ã®ä¸€ç’°ã§ã™ã‹ï¼Ÿ',
                subText: 'è·å“¡ä¼šè­°ã€ä¿è­·è€…ä¼šã€å­¦æ ¡HPã¸ã®æ²è¼‰ãªã©ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚',
                yes: 'q_class_2',
                no: 'r_ng_general'
            },
            q_class_2: {
                text: 'ã‚³ãƒ”ãƒ¼ã‚„é€ä¿¡ã‚’è¡Œã†ã®ã¯ã€ã€Œæˆæ¥­ã‚’æ‹…å½“ã™ã‚‹å…ˆç”Ÿã€ã¾ãŸã¯ã€Œãã®æˆæ¥­ã‚’å—ã‘ã‚‹ç”Ÿå¾’ã€ã§ã™ã‹ï¼Ÿ',
                subText: 'äº‹å‹™è·å“¡ãŒå…¨æ ¡åˆ†ã‚’ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ã™ã‚‹å ´åˆãªã©ã¯åŸå‰‡ã¨ã—ã¦å¯¾è±¡å¤–ã§ã™ã€‚',
                yes: 'q_class_3',
                no: 'r_ng_person'
            },
            q_class_3: {
                text: 'ã€Œãƒ‰ãƒªãƒ«ã€ã‚„ã€Œãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã€ãªã©ã€ç”Ÿå¾’ãŒè³¼å…¥ã—ã¦æ›¸ãè¾¼ã‚€ã“ã¨ã‚’å‰æã¨ã—ãŸæ•™æã‚’ã‚³ãƒ”ãƒ¼ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ',
                yes: 'r_ng_drill',
                no: 'q_class_4'
            },
            q_class_4: {
                text: 'åˆ©ç”¨ã™ã‚‹é‡ã¯ã€æˆæ¥­ã«å¿…è¦ãªã€Œä¸€éƒ¨åˆ†ã€ã‚„ã€Œå°éƒ¨åˆ†ã€ã«ã¨ã©ã¾ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ',
                subText: 'æ•™ç§‘æ›¸ã¾ã‚‹ã”ã¨ã®ã‚³ãƒ”ãƒ¼ãªã©ã¯NGã§ã™ã€‚',
                yes: 'r_ok_class',
                no: 'r_ng_amount'
            },

            // --- ã‚¤ãƒ™ãƒ³ãƒˆã‚·ãƒ¼ãƒ³ ---
            q_event_1: {
                text: 'ãã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œå–¶åˆ©ç›®çš„ï¼ˆãŠé‡‘å„²ã‘ï¼‰ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ',
                subText: 'é€šå¸¸ã®å­¦æ ¡è¡Œäº‹ï¼ˆæ–‡åŒ–ç¥­ãªã©ï¼‰ã¯ã€Œå–¶åˆ©ç›®çš„ã§ã¯ãªã„ã€ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚',
                yes: 'q_event_2',
                no: 'r_ng_profit'
            },
            q_event_2: {
                text: 'è¦³å®¢ã‹ã‚‰ã€Œå…¥å ´æ–™ï¼ˆãƒã‚±ãƒƒãƒˆä»£ï¼‰ã€ãªã©ã‚’å¾´åã—ã¾ã™ã‹ï¼Ÿ',
                yes: 'r_ng_ticket',
                no: 'q_event_3'
            },
            q_event_3: {
                text: 'å‡ºæ¼”è€…ã‚„æ¼”å¥è€…ï¼ˆãƒ—ãƒ­ãƒ»ã‚¢ãƒå•ã‚ãšï¼‰ã«ã€Œå ±é…¬ï¼ˆã‚®ãƒ£ãƒ©ï¼‰ã€ã‚’æ”¯æ‰•ã„ã¾ã™ã‹ï¼Ÿ',
                yes: 'r_ng_fee',
                no: 'q_event_4'
            },
            q_event_4: {
                text: 'å¸‚è²©ã®æ˜ ç”»ï¼ˆDVD/Blu-rayï¼‰ã‚’ä¸Šæ˜ ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ',
                yes: 'r_ng_movie',
                no: 'r_ok_event'
            },

            // --- åˆ¶ä½œãƒ»å¼•ç”¨ã‚·ãƒ¼ãƒ³ ---
            q_creative_1: {
                text: 'ä»–äººã®ä½œå“ã‚’ä½¿ã†å ´åˆã€ãã®ä½œå“ã¯ã™ã§ã«ã€Œå…¬è¡¨ã€ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ',
                yes: 'q_creative_2',
                no: 'r_ng_unpublished'
            },
            q_creative_2: {
                text: 'è‡ªåˆ†ã®æ–‡ç« ã‚„çµµãŒã€Œä¸»ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ã€ã§ã€ä½¿ã„ãŸã„ä»–äººã®ä½œå“ãŒã€Œå¾“ï¼ˆã‚µãƒ–ï¼‰ã€ã®é–¢ä¿‚ã§ã™ã‹ï¼Ÿ',
                subText: 'ä»–äººã®çµµã ã‘ã‚’è²¼ã£ã¦ã€æ„Ÿæƒ³ãŒä¸€è¨€ã ã‘ã®å ´åˆã¯NGã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚',
                yes: 'q_creative_3',
                no: 'r_ng_relation'
            },
            q_creative_3: {
                text: 'å‡ºå…¸ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»ä½œè€…åãªã©ï¼‰ã‚’æ˜è¨˜ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ',
                yes: 'q_creative_4',
                no: 'r_ng_source'
            },
            q_creative_4: {
                text: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼ˆSNSã‚„èª°ã§ã‚‚è¦‹ã‚‰ã‚Œã‚‹å­¦æ ¡HPï¼‰ã«å…¬é–‹ã™ã‚‹äºˆå®šã§ã™ã‹ï¼Ÿ',
                yes: 'r_check_online',
                no: 'r_ok_quote'
            },

            // --- çµæœãƒ‡ãƒ¼ã‚¿ ---
            r_ok_class: {
                type: 'ok',
                title: 'åŸå‰‡ OK ã§ã™',
                message: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡ã«ã‚ˆã‚Šã€å­¦æ ¡ã®æˆæ¥­ã§ã®åˆ©ç”¨ã¯è¨±è«¾ãªãè¡Œãˆã¾ã™ã€‚',
                details_teacher: 'ç´™ã®ã‚³ãƒ”ãƒ¼ã ã‘ã§ãªãã€Google Classroomç­‰ã§ã®é…ä¿¡ã‚‚ã€Œæˆæ¥­ç›®çš„å…¬è¡†é€ä¿¡è£œå„Ÿé‡‘ï¼ˆSARTRASï¼‰ã€ã«å­¦æ ¡ãŒåŠ å…¥ã—ã¦ã„ã‚Œã°å¯èƒ½ã§ã™ï¼ˆå¤šãã®å­¦æ ¡ãŒåŠ å…¥æ¸ˆï¼‰ã€‚ãŸã ã—ã€æˆæ¥­çµ‚äº†å¾Œã¯ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ç­‰ã®é©åˆ‡ãªç®¡ç†ï¼ˆé‹ç”¨æŒ‡é‡ã®éµå®ˆï¼‰ãŒå¿…è¦ã§ã™ã€‚',
                details_student: 'æˆæ¥­ã®ç™ºè¡¨ãªã©ã§ä½¿ã†åˆ†ã«ã¯OKã§ã™ã€‚ãŸã ã—ã€ãã®è³‡æ–™ã‚’å‹æ‰‹ã«SNSã«ã‚¢ãƒƒãƒ—ã™ã‚‹ã®ã¯ãƒ«ãƒ¼ãƒ«é•åã«ãªã‚‹ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡ã€SARTRASé‹ç”¨æŒ‡é‡'
            },
            r_ok_event: {
                type: 'ok',
                title: 'åŸå‰‡ OK ã§ã™',
                message: 'è‘—ä½œæ¨©æ³•ç¬¬38æ¡ç¬¬1é …ã«ã‚ˆã‚Šã€éå–¶åˆ©ãƒ»ç„¡æ–™ãƒ»ç„¡å ±é…¬ã§ã‚ã‚Œã°ã€ä¸Šæ¼”ãƒ»æ¼”å¥ãŒå¯èƒ½ã§ã™ã€‚',
                details_teacher: 'ã“ã®è¦å®šã¯ã€Œå®Ÿæ¼”ã€ã«é™ã‚‰ã‚Œã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã®æ§˜å­ã‚’éŒ²ç”»ã—ã¦YouTubeç­‰ã§é…ä¿¡ã™ã‚‹å ´åˆã¯ã€ç¬¬38æ¡ã®å¯¾è±¡å¤–ã¨ãªã‚Šã€JASRACç­‰ã¸ã®è¨±è«¾æ‰‹ç¶šããŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã”æ³¨æ„ãã ã•ã„ã€‚',
                details_student: 'æ–‡åŒ–ç¥­ã§ã®ãƒãƒ³ãƒ‰æ¼”å¥ã‚„æ¼”åŠ‡ã¯OKã§ã™ï¼ ãŸã ã—ã€ã‚¹ãƒãƒ›ã§æ’®å½±ã—ãŸå‹•ç”»ã‚’è¨±å¯ãªãã‚¤ãƒ³ã‚¹ã‚¿ã‚„YouTubeã«è¼‰ã›ã‚‹ã®ã¯è‘—ä½œæ¨©ä¾µå®³ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬38æ¡ç¬¬1é …'
            },
            r_ok_quote: {
                type: 'ok',
                title: 'å¼•ç”¨ã¨ã—ã¦ OK ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™',
                message: 'è‘—ä½œæ¨©æ³•ç¬¬32æ¡ã®ã€Œå¼•ç”¨ã€ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚',
                details_teacher: 'å¼•ç”¨ã¯è‘—ä½œè€…ã®è¨±è«¾ä¸è¦ã§è¡Œãˆã‚‹å¼·åŠ›ãªæ¨©åˆ©ã§ã™ãŒã€è¦ä»¶ï¼ˆä¸»å¾“é–¢ä¿‚ã€æ˜ç­åŒºåˆ†ã€å‡ºå…¸æ˜ç¤ºãªã©ï¼‰ã¯å³æ ¼ã§ã™ã€‚ç”Ÿå¾’ã¸ã®æŒ‡å°ã®éš›ã¯ã€Œè‡ªåˆ†ã®æ„è¦‹ãŒãƒ¡ã‚¤ãƒ³ã§ã‚ã‚‹ã“ã¨ã€ã‚’å¼·èª¿ã—ã¦ãã ã•ã„ã€‚',
                details_student: 'ã€Œå¼•ç”¨ã€ã¨ã—ã¦èªã‚ã‚‰ã‚Œã‚‹æ­£ã—ã„ä½¿ã„æ–¹ã§ã™ã€‚å‡ºå…¸ï¼ˆã©ã“ã‹ã‚‰æŒã£ã¦ããŸã‹ï¼‰ã‚‚ã—ã£ã‹ã‚Šæ›¸ã‘ã¦ã„ã‚‹ã®ã§ã€å®‰å¿ƒã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã«ä½¿ã£ã¦ãã ã•ã„ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬32æ¡'
            },
            r_check_online: {
                type: 'warning',
                title: 'è¦æ³¨æ„ï¼ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹',
                message: 'å¼•ç”¨ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚Œã°å…¬é–‹å¯èƒ½ã§ã™ãŒã€ãƒãƒ¼ãƒ‰ãƒ«ã¯é«˜ã„ã§ã™ã€‚',
                details_teacher: 'å­¦æ ¡HPã‚„SNSã§ã®å…¬é–‹ã¯ã€Œå…¬è¡†é€ä¿¡ã€ã«ã‚ãŸã‚Šã¾ã™ã€‚å¼•ç”¨è¦ä»¶ã‚’å®Œå…¨ã«æº€ãŸã—ã¦ã„ã‚Œã°è¨±è«¾ä¸è¦ã§ã™ãŒã€è‚–åƒæ¨©ã‚„è‘—ä½œè€…äººæ ¼æ¨©ï¼ˆæ”¹å¤‰ç¦æ­¢ãªã©ï¼‰ã®ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚‹ãŸã‚ã€å…¬é–‹å‰ã«å¿…ãšç®¡ç†è·ã‚„æ‹…å½“è€…ã¨ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚',
                details_student: 'ãƒãƒƒãƒˆã«ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨å…¨ä¸–ç•Œã®äººãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ã‚‚ã—ã€Œå¼•ç”¨ã€ã®ãƒ«ãƒ¼ãƒ«ã‚’å°‘ã—ã§ã‚‚ç ´ã£ã¦ã„ã‚‹ã¨ãƒˆãƒ©ãƒ–ãƒ«ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å…ˆç”Ÿã«å¿…ãšè¦‹ã¦ã‚‚ã‚‰ã£ã¦ã‹ã‚‰å…¬é–‹ã—ã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬23æ¡ï¼ˆå…¬è¡†é€ä¿¡æ¨©ï¼‰ã€ç¬¬32æ¡'
            },
            r_ng_general: {
                type: 'ng',
                title: 'åŸå‰‡ NGï¼ˆè¨±è«¾ãŒå¿…è¦ã§ã™ï¼‰',
                message: 'æˆæ¥­ä»¥å¤–ã®ç›®çš„ï¼ˆè·å“¡ä¼šè­°ã€å­¦æ ¡é‹å–¶ã€ä¿è­·è€…å‘ã‘åºƒå ±ãªã©ï¼‰ã§ã®åˆ©ç”¨ã¯ã€ç¬¬35æ¡ã®å¯¾è±¡å¤–ã§ã™ã€‚',
                details_teacher: 'ç¬¬35æ¡ã¯ã€Œæ•™è‚²èª²ç¨‹ä¸Šã®æˆæ¥­ã€ã«é™å®šã•ã‚Œã¦ã„ã¾ã™ã€‚è·å“¡ä¼šè­°è³‡æ–™ã‚„å­¦æ ¡è¦è¦§ãªã©ã§ä»–äººã®è‘—ä½œç‰©ã‚’ä½¿ã†å ´åˆã¯ã€ä¼æ¥­ã¨åŒæ§˜ã«è¨±è«¾ãŒå¿…è¦ã§ã™ï¼ˆã¾ãŸã¯ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°å¥‘ç´„ãªã©ã®ç¢ºèªã‚’ï¼‰ã€‚',
                details_student: 'æˆæ¥­ã«é–¢ä¿‚ãªã„ã¨ã“ã‚ã§å‹æ‰‹ã«ä½¿ã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡ï¼ˆé©ç”¨å¤–ï¼‰'
            },
            r_ng_person: {
                type: 'ng',
                title: 'åŸå‰‡ NGï¼ˆæ‹…å½“è€…ãŒè¡Œã£ã¦ãã ã•ã„ï¼‰',
                message: 'ç¬¬35æ¡ã§èªã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯ã€Œæˆæ¥­æ‹…å½“è€…ã€ã¨ã€Œå—è¬›è€…ã€ã«ã‚ˆã‚‹è¤‡è£½ãƒ»é€ä¿¡ã§ã™ã€‚',
                details_teacher: 'ä¾‹ãˆã°ã€ç®¡ç†è·ã‚„äº‹å‹™è·å“¡ãŒã€æ‹…å½“å¤–ã®æˆæ¥­ã®ãŸã‚ã«æ•™æã‚’ä¸€æ‹¬ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã¯35æ¡ã®ç¯„å›²å¤–ã¨è§£é‡ˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚æ‹…å½“æ•™å“¡è‡ªèº«ãŒè¡Œã†ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚',
                details_student: 'å…ˆç”Ÿã‚„æˆæ¥­ã‚’å—ã‘ã‚‹ç”Ÿå¾’ä»¥å¤–ãŒå‹æ‰‹ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡'
            },
            r_ng_drill: {
                type: 'ng',
                title: 'NGï¼ˆè¨±è«¾ãŒå¿…è¦ã§ã™ï¼‰',
                message: 'ãƒ‰ãƒªãƒ«ã‚„ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ãªã©ã€ç”Ÿå¾’ãŒè³¼å…¥ã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ãŸæ•™æã®ã‚³ãƒ”ãƒ¼ã¯èªã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚',
                details_teacher: 'ã“ã‚Œã¯ã€Œè‘—ä½œæ¨©è€…ã®åˆ©ç›Šã‚’ä¸å½“ã«å®³ã™ã‚‹å ´åˆã€ã«è©²å½“ã—ã¾ã™ï¼ˆ35æ¡ãŸã ã—æ›¸ãï¼‰ã€‚æ•™è‚²ç›®çš„ã§ã‚ã£ã¦ã‚‚é•æ³•ã¨ãªã‚Šã¾ã™ã€‚äººæ•°åˆ†è³¼å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
                details_student: 'ä¸€äººä¸€å†Šè²·ã†ã¹ããƒ‰ãƒªãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ¸ˆã¾ã›ã‚‹ã“ã¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡ãŸã ã—æ›¸ã'
            },
            r_ng_amount: {
                type: 'ng',
                title: 'NG ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™',
                message: 'å…¨éƒ¨ã®ã‚³ãƒ”ãƒ¼ã‚„ã€éå¤§ãªé‡ã®åˆ©ç”¨ã¯èªã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚',
                details_teacher: 'ã€Œå¿…è¦ã¨èªã‚ã‚‰ã‚Œã‚‹é™åº¦ã€ã‚’è¶…ãˆã‚‹åˆ©ç”¨ã¯ã§ãã¾ã›ã‚“ã€‚å¸‚è²©æœ¬ã‚’ã¾ã‚‹ã”ã¨PDFåŒ–ã—ã¦é…ä¿¡ã™ã‚‹ãªã©ã¯NGã§ã™ã€‚',
                details_student: 'æœ¬ã‚’ä¸€å†Šã¾ã‚‹ã”ã¨ã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã™ã‚‹ã®ã¯ãƒ€ãƒ¡ã§ã™ã€‚æˆæ¥­ã«å¿…è¦ãªéƒ¨åˆ†ã ã‘ã«ã—ã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬35æ¡'
            },
            r_ng_profit: {
                type: 'ng',
                title: 'NGï¼ˆè¨±è«¾ãŒå¿…è¦ã§ã™ï¼‰',
                message: 'å–¶åˆ©ç›®çš„ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ã€ç„¡æ–­åˆ©ç”¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                details_teacher: 'å¤–éƒ¨å›£ä½“ã¨å…±å‚¬ã§åç›Šã‚’å¾—ã‚‹å ´åˆãªã©ã¯ã€JASRACç­‰ã¸ã®æ‰‹ç¶šããŒå¿…è¦ã§ã™ã€‚',
                details_student: 'ãŠé‡‘å„²ã‘ãŒç›®çš„ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ã€è¨±å¯ãªãéŸ³æ¥½ã‚„è„šæœ¬ã‚’ä½¿ã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬38æ¡ï¼ˆé©ç”¨å¤–ï¼‰'
            },
            r_ng_ticket: {
                type: 'ng',
                title: 'NGï¼ˆè¨±è«¾ãŒå¿…è¦ã§ã™ï¼‰',
                message: 'å…¥å ´æ–™ã‚’å–ã‚‹å ´åˆã€ç¬¬38æ¡ã®ä¾‹å¤–ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚',
                details_teacher: 'ãƒã‚±ãƒƒãƒˆä»£ã ã‘ã§ãªãã€è³‡æ–™ä»£ãªã©ã®åç›®ã§ã‚‚å®Ÿè³ªçš„ãªå¯¾ä¾¡ã¨ã¿ãªã•ã‚Œã‚Œã°NGã§ã™ã€‚JASRACç­‰ã¸ã®ç”³è«‹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚',
                details_student: 'ãŠå®¢ã•ã‚“ã‹ã‚‰ãŠé‡‘ã‚’ã‚‚ã‚‰ã†å ´åˆã¯ã€éŸ³æ¥½ã‚„åŠ‡ã‚’ä½¿ã†ã®ã«æ‰‹ç¶šãã¨ãŠé‡‘ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬38æ¡ï¼ˆé©ç”¨å¤–ï¼‰'
            },
            r_ng_fee: {
                type: 'ng',
                title: 'NGï¼ˆè¨±è«¾ãŒå¿…è¦ã§ã™ï¼‰',
                message: 'å‡ºæ¼”è€…ã«å ±é…¬ã‚’æ”¯æ‰•ã†å ´åˆã€ç¬¬38æ¡ã®ä¾‹å¤–ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚',
                details_teacher: 'è¬ç¤¼ãŒå‡ºã‚‹ã‚²ã‚¹ãƒˆæ¼”å¥ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚’å‘¼ã¶å ´åˆã¯ç‰¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚',
                details_student: 'æ¼”å¥ã—ã¦ãã‚Œã‚‹äººã«ãŠé‡‘ã‚’æ‰•ã†å ´åˆã¯ã€è‡ªç”±ã«éŸ³æ¥½ã‚’ä½¿ã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬38æ¡ï¼ˆé©ç”¨å¤–ï¼‰'
            },
            r_ng_movie: {
                type: 'ng',
                title: 'åŸå‰‡ NGï¼ˆæ¥­å‹™ç”¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒå¿…è¦ï¼‰',
                message: 'å¸‚è²©ã®DVDç­‰ã¯ã€Œå®¶åº­å†…è¦–è´ã€ã«é™ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚',
                details_teacher: 'å­¦æ ¡è¡Œäº‹ã§ã®æ˜ ç”»ä¸Šæ˜ ã¯ã€Œé ’å¸ƒæ¨©ï¼ˆæ˜ ç”»ï¼‰ã€ã‚„ã€Œä¸Šæ˜ æ¨©ã€ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚æ•™è‚²æ©Ÿé–¢å‘ã‘ã®ä¸Šæ˜ è¨±è«¾ä»˜ããƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’è³¼å…¥ãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæˆæ¥­ã®ä¸€ç’°ã¨ã—ã¦æ•™å®¤ã§è¦‹ã‚‹å ´åˆã¯OKã®ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã¾ã™ãŒã€è¡Œäº‹ã¯å³æ ¼ã§ã™ï¼‰ã€‚',
                details_student: 'ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ“ãƒ‡ã‚ªåº—ã‚„ãŠåº—ã§è²·ã£ãŸDVDã¯ã€Œå®¶ã§è¦‹ã‚‹ã€ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚å­¦æ ¡ã®ã¿ã‚“ãªã§è¦‹ã‚‹ä¸Šæ˜ ä¼šã«ã¯ç‰¹åˆ¥ãªè¨±å¯ãŒå¿…è¦ã§ã™ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬22æ¡ã®2ï¼ˆä¸Šæ˜ æ¨©ï¼‰ã€ç¬¬26æ¡ï¼ˆé ’å¸ƒæ¨©ï¼‰'
            },
            r_ng_unpublished: {
                type: 'ng',
                title: 'NG',
                message: 'æœªå…¬è¡¨ã®è‘—ä½œç‰©ï¼ˆå€‹äººçš„ãªæ‰‹ç´™ã‚„æ—¥è¨˜ã€æœªç™ºè¡¨ã®å°èª¬ãªã©ï¼‰ã¯å¼•ç”¨ã§ãã¾ã›ã‚“ã€‚',
                details_teacher: 'å…¬è¡¨æ¨©ï¼ˆè‘—ä½œè€…äººæ ¼æ¨©ï¼‰ã®ä¾µå®³ã«ãªã‚Šã¾ã™ã€‚',
                details_student: 'ã¾ã ä¸–ã«å‡ºã¦ã„ãªã„ã‚‚ã®ã‚„ã€å€‹äººçš„ãªã‚‚ã®ã‚’å‹æ‰‹ã«ä½¿ã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬18æ¡ï¼ˆå…¬è¡¨æ¨©ï¼‰'
            },
            r_ng_relation: {
                type: 'ng',
                title: 'NGï¼ˆãŸã ã®è»¢è¼‰ã«ãªã‚Šã¾ã™ï¼‰',
                message: 'è‡ªåˆ†ã®å‰µä½œæ€§ãŒãƒ¡ã‚¤ãƒ³ã§ãªã‘ã‚Œã°å¼•ç”¨ã¨ã¯èªã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚',
                details_teacher: 'ã€Œä¸»å¾“é–¢ä¿‚ã€ãŒé€†è»¢ã—ã¦ã„ã¾ã™ã€‚å¼•ç”¨ç®‡æ‰€ã¯ã‚ãã¾ã§è‡ªèª¬ã‚’è£œå¼·ã™ã‚‹ãŸã‚ã®å¾“ãŸã‚‹å­˜åœ¨ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚',
                details_student: 'ã€Œã„ã„çµµãŒã‚ã£ãŸã‹ã‚‰è²¼ã‚Šä»˜ã‘ãŸã€ã ã‘ã§ã¯ãƒ€ãƒ¡ã§ã™ã€‚è‡ªåˆ†ã®æ–‡ç« ã‚„è€ƒãˆãŒãƒ¡ã‚¤ãƒ³ã§ã€ãã®ãŸã‚ã«ã©ã†ã—ã¦ã‚‚å¿…è¦ãªæ™‚ã ã‘ä½¿ã„ã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬32æ¡'
            },
            r_ng_source: {
                type: 'ng',
                title: 'NG',
                message: 'å¼•ç”¨ã«ã¯ã€Œå‡ºå…¸ã®æ˜ç¤ºã€ãŒç¾©å‹™ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚',
                details_teacher: 'è‘—ä½œè€…åã‚„ä½œå“åãªã©ã‚’å¿…ãšè¨˜è¼‰ã™ã‚‹ã‚ˆã†æŒ‡å°ã—ã¦ãã ã•ã„ã€‚',
                details_student: 'ã€Œèª°ã®ãƒ»ã©ã®ä½œå“ã‹ã€ã‚’æ›¸ã‹ãªã„ã¨ã€Œç›—ä½œï¼ˆãƒ‘ã‚¯ãƒªï¼‰ã€ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚å¿…ãšæ›¸ãã¾ã—ã‚‡ã†ã€‚',
                legal: 'è‘—ä½œæ¨©æ³•ç¬¬48æ¡ï¼ˆå‡ºæ‰€ã®æ˜ç¤ºï¼‰'
            }
        };

        // ==========================================
        // Functions (ãƒ­ã‚¸ãƒƒã‚¯)
        // ==========================================

        function setAppMode(mode) {
            state.appMode = mode;
            render();
        }

        function setUserType(type) {
            state.userType = type;
            state.scene = null;
            state.currentQuestionId = null;
            state.result = null;
            state.history = [];
            render();
        }

        function setScene(sceneId) {
            state.scene = scenes.find(s => s.id === sceneId);
            state.currentQuestionId = state.scene.startQuestion;
            state.history = [];
            state.result = null;
            render();
        }

        function handleAnswer(answer) {
            const currentQuestion = data[state.currentQuestionId];
            const nextId = answer ? currentQuestion.yes : currentQuestion.no;

            state.history.push(state.currentQuestionId);

            if (nextId.startsWith('r_')) {
                state.result = data[nextId];
                state.currentQuestionId = null;
            } else {
                state.currentQuestionId = nextId;
            }
            render();
        }

        function resetChecker() {
            state.scene = null;
            state.currentQuestionId = null;
            state.result = null;
            state.history = [];
            render();
        }

        function fullReset() {
            state.userType = null;
            resetChecker();
        }

        function goBack() {
            if (state.history.length === 0) {
                resetChecker();
                return;
            }
            const prevQuestionId = state.history.pop();
            state.result = null;
            state.currentQuestionId = prevQuestionId;
            render();
        }

        // --- Citation Functions ---
        function setCitationType(type) {
            state.citationType = type;
            render();
        }

        function updateCitationData(field, value) {
            state.citationData[field] = value;
            renderPreviewOnly(); // å…¨ä½“å†æç”»ã‚’é¿ã‘ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã ã‘æ›´æ–°
        }

        function getFormattedCitation() {
            const { author, title, publisher, year, url, accessDate } = state.citationData;
            const type = state.citationType;

            if (type === 'book') {
                if (!author && !title) return 'ï¼ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰';
                return `${author || 'è‘—è€…å'}. ã€${title || 'æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«'}ã€. ${publisher || 'å‡ºç‰ˆç¤¾'}, ${year || 'å‡ºç‰ˆå¹´'}.`;
            } else if (type === 'web') {
                if (!title && !url) return 'ï¼ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰';
                return `${author ? author + '. ' : ''}â€œ${title || 'Webãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«'}â€. ${publisher || 'Webã‚µã‚¤ãƒˆå'}. ${url || 'URL'}, (å‚ç…§ ${accessDate || 'é–²è¦§æ—¥'}).`;
            } else if (type === 'article') {
                if (!title) return 'ï¼ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰';
                return `${author || 'è‘—è€…å'}. â€œ${title || 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'}â€. ${publisher || 'æ²è¼‰èªŒå'}. ${year || 'ç™ºè¡Œå¹´'}, p.xx-xx.`;
            }
            return '';
        }

        // ==========================================
        // Rendering (æç”»)
        // ==========================================
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éƒ¨åˆ†ã®ã¿æ›´æ–°ï¼ˆinputã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
        function renderPreviewOnly() {
            const previewEl = document.getElementById('citation-preview');
            if (previewEl) {
                previewEl.textContent = getFormattedCitation();
            }
        }

        function render() {
            const mainContent = document.getElementById('main-content');
            const tabChecker = document.getElementById('tab-checker');
            const tabCitation = document.getElementById('tab-citation');

            // Header Tabs Styling
            if (state.appMode === 'checker') {
                tabChecker.className = 'flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-indigo-600 border-b-4 border-indigo-600 bg-indigo-50';
                tabCitation.className = 'flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-slate-500 hover:bg-slate-50';
            } else {
                tabChecker.className = 'flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-slate-500 hover:bg-slate-50';
                tabCitation.className = 'flex-1 py-4 text-center font-bold flex items-center justify-center gap-2 transition-colors text-green-600 border-b-4 border-green-600 bg-green-50';
            }

            // Main Content Rendering
            let html = '';

            if (state.appMode === 'checker') {
                html += '<div class="animate-fade-in">';

                // Step 1: User Type Selection
                if (!state.userType) {
                    html += `
                        <div class="max-w-2xl mx-auto mt-8">
                            <h2 class="text-2xl font-bold text-center mb-8 text-slate-700">ã‚ãªãŸã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ</h2>
                            <div class="grid md:grid-cols-2 gap-6">
                                <button onclick="setUserType('student')" class="bg-white border-2 border-indigo-100 hover:border-indigo-500 p-8 rounded-2xl shadow-sm hover:shadow-xl transition-all group flex flex-col items-center">
                                    <div class="bg-indigo-100 p-4 rounded-full mb-4 group-hover:bg-indigo-600 transition-colors">
                                        <i data-lucide="user" class="w-10 h-10 text-indigo-600 group-hover:text-white"></i>
                                    </div>
                                    <span class="text-xl font-bold text-slate-700">ç”Ÿå¾’ãƒ»å­¦ç”Ÿ</span>
                                    <span class="text-sm text-slate-500 mt-2">ãƒ¬ãƒãƒ¼ãƒˆã‚„æ–‡åŒ–ç¥­ã§ã®åˆ©ç”¨ã«ã¤ã„ã¦</span>
                                </button>
                                <button onclick="setUserType('teacher')" class="bg-white border-2 border-emerald-100 hover:border-emerald-500 p-8 rounded-2xl shadow-sm hover:shadow-xl transition-all group flex flex-col items-center">
                                    <div class="bg-emerald-100 p-4 rounded-full mb-4 group-hover:bg-emerald-600 transition-colors">
                                        <i data-lucide="graduation-cap" class="w-10 h-10 text-emerald-600 group-hover:text-white"></i>
                                    </div>
                                    <span class="text-xl font-bold text-slate-700">æ•™è·å“¡</span>
                                    <span class="text-sm text-slate-500 mt-2">æˆæ¥­ã€æ ¡å‹™ã€è¡Œäº‹ã§ã®åˆ©ç”¨ã«ã¤ã„ã¦</span>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Step 2: Scene Selection
                else if (state.userType && !state.scene) {
                    html += `
                        <div class="animate-slide-up">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-lg font-bold text-slate-700">
                                    <span class="bg-slate-200 text-slate-700 px-2 py-1 rounded text-sm mr-2">
                                        ${state.userType === 'teacher' ? 'æ•™è·å“¡ç”¨' : 'ç”Ÿå¾’ç”¨'}
                                    </span>
                                    å ´é¢ã‚’é¸ã‚“ã§ãã ã•ã„
                                </h2>
                                <button onclick="fullReset()" class="text-sm text-slate-500 underline">åˆ©ç”¨è€…é¸æŠã«æˆ»ã‚‹</button>
                            </div>

                            <div class="grid md:grid-cols-3 gap-4">
                                ${scenes.map(s => `
                                    <button onclick="setScene('${s.id}')" class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md border border-slate-200 flex flex-col items-center text-center transition-all hover:bg-slate-50 group">
                                        <div class="transform group-hover:scale-110 transition-transform duration-200">
                                            <i data-lucide="${s.icon}" class="w-8 h-8 mb-2 ${s.color}"></i>
                                        </div>
                                        <h3 class="font-bold text-lg mb-2">${s.title}</h3>
                                        <p class="text-sm text-slate-500">${s.description}</p>
                                    </button>
                                `).join('')}
                            </div>

                            <div class="mt-8 bg-blue-50 p-4 rounded-lg text-sm text-blue-800 flex gap-3 border border-blue-100">
                                <i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i>
                                <p>
                                    ã“ã®ãƒ„ãƒ¼ãƒ«ã¯æ–‡åŒ–åºã€Œè‘—ä½œæ¨©ãƒ†ã‚­ã‚¹ãƒˆã€ç­‰ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ç°¡æ˜“çš„ãªåˆ¤æ–­åŸºæº–ã‚’ç¤ºã™ã‚‚ã®ã§ã™ã€‚
                                    æœ€çµ‚çš„ãªæ³•çš„åˆ¤æ–­ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¿·ã£ãŸå ´åˆã¯
                                    ${state.userType === 'student' ? 'å…ˆç”Ÿã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚' : 'ç®¡ç†è·ã‚„å°‚é–€å®¶ã€è‡ªæ²»ä½“ã®æ³•å‹™æ‹…å½“ã«ã”ç›¸è«‡ãã ã•ã„ã€‚'}
                                </p>
                            </div>
                        </div>
                    `;
                }

                // Step 3: Question Flow
                else if (state.scene && !state.result && state.currentQuestionId) {
                    const q = data[state.currentQuestionId];
                    html += `
                        <div class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden animate-slide-up mt-4">
                            <div class="bg-slate-100 p-3 px-6 flex justify-between items-center border-b border-slate-200">
                                <span class="font-bold text-slate-600 flex items-center gap-2">
                                    <i data-lucide="${state.scene.icon}" class="${state.scene.color}"></i>
                                    ${state.scene.title}
                                </span>
                                <button onclick="resetChecker()" class="text-xs text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> æœ€åˆã‹ã‚‰
                                </button>
                            </div>
                            
                            <div class="p-8 text-center">
                                <h3 class="text-xl md:text-2xl font-bold mb-4 leading-relaxed text-slate-800">
                                    ${q.text}
                                </h3>
                                ${q.subText ? `
                                    <p class="text-slate-500 text-sm mb-8 bg-slate-50 inline-block px-4 py-2 rounded-lg border border-slate-200">
                                        ğŸ’¡ ${q.subText}
                                    </p>
                                ` : ''}
                                
                                <div class="flex flex-col md:flex-row gap-4 justify-center">
                                    <button onclick="handleAnswer(true)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-full font-bold text-lg shadow-md transition-transform active:scale-95 flex-1 md:max-w-xs flex items-center justify-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i> ã¯ã„ (Yes)
                                    </button>
                                    <button onclick="handleAnswer(false)" class="bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 px-8 py-4 rounded-full font-bold text-lg shadow-sm transition-transform active:scale-95 flex-1 md:max-w-xs flex items-center justify-center gap-2">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i> ã„ã„ãˆ (No)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-3 border-t border-slate-100">
                                <button onclick="goBack()" class="text-slate-500 text-sm hover:underline px-4 flex items-center gap-1">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i> å‰ã®è³ªå•ã«æˆ»ã‚‹
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Step 4: Result Display
                else if (state.result) {
                    const r = state.result;
                    let borderColor, bgColor, icon;
                    
                    if (r.type === 'ok') {
                        borderColor = 'border-green-500';
                        bgColor = 'bg-green-600';
                        icon = 'check-circle';
                    } else if (r.type === 'ng') {
                        borderColor = 'border-red-500';
                        bgColor = 'bg-red-600';
                        icon = 'x-circle';
                    } else {
                        borderColor = 'border-amber-500';
                        bgColor = 'bg-amber-500';
                        icon = 'alert-triangle';
                    }

                    html += `
                        <div class="animate-scale-in mt-4">
                            <div class="rounded-xl shadow-xl overflow-hidden border-2 ${borderColor}">
                                
                                <div class="p-6 text-white text-center ${bgColor}">
                                    <i data-lucide="${icon}" class="w-16 h-16 mx-auto mb-2"></i>
                                    <h2 class="text-2xl font-bold">${r.title}</h2>
                                </div>

                                <div class="bg-white p-6 md:p-8">
                                    <h3 class="text-xl font-bold text-slate-800 mb-3">${r.message}</h3>
                                    
                                    <div class="bg-slate-50 border-l-4 border-indigo-500 p-4 mb-6 rounded-r-lg">
                                        <p class="font-bold text-indigo-700 mb-1 text-sm flex items-center gap-2">
                                            <i data-lucide="${state.userType === 'teacher' ? 'graduation-cap' : 'user'}" class="w-4 h-4"></i>
                                            ${state.userType === 'teacher' ? 'æ•™è·å“¡ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹' : 'ç”Ÿå¾’ã®ã¿ãªã•ã‚“ã¸'}
                                        </p>
                                        <p class="text-slate-700 leading-relaxed text-sm md:text-base">
                                            ${state.userType === 'teacher' ? r.details_teacher : r.details_student}
                                        </p>
                                    </div>

                                    <div class="border-t border-slate-100 pt-4">
                                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Legal Basis</p>
                                        <p class="text-sm text-slate-500 font-mono bg-slate-100 inline-block px-2 py-1 rounded">
                                            ${r.legal}
                                        </p>
                                    </div>

                                    <div class="mt-8 flex justify-center">
                                        <button onclick="resetChecker()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-indigo-700 transition-colors flex items-center gap-2">
                                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                            ä»–ã®ã‚±ãƒ¼ã‚¹ã‚’èª¿ã¹ã‚‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += '</div>'; // End animate-fade-in
            }

            // Mode: Citation
            else if (state.appMode === 'citation') {
                html += `
                    <div class="animate-fade-in max-w-3xl mx-auto">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">å‚è€ƒæ–‡çŒ®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                            <p class="text-slate-500">
                                ãƒ¬ãƒãƒ¼ãƒˆã‚„è«–æ–‡ã®æœ«å°¾ã«è¨˜è¼‰ã™ã‚‹ã€Œå‚è€ƒæ–‡çŒ®ã€ã®ãƒªã‚¹ãƒˆã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚<br/>
                                è³‡æ–™ã®ç¨®é¡ã‚’é¸ã‚“ã§æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>

                        <!-- Type Select -->
                        <div class="flex gap-2 mb-6 justify-center">
                            <button onclick="setCitationType('book')" class="px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all ${state.citationType === 'book' ? 'bg-green-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}">
                                <i data-lucide="book" class="w-4 h-4"></i> æ›¸ç±ãƒ»æœ¬
                            </button>
                            <button onclick="setCitationType('web')" class="px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all ${state.citationType === 'web' ? 'bg-green-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}">
                                <i data-lucide="globe" class="w-4 h-4"></i> Webã‚µã‚¤ãƒˆ
                            </button>
                            <button onclick="setCitationType('article')" class="px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all ${state.citationType === 'article' ? 'bg-green-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}">
                                <i data-lucide="file-text" class="w-4 h-4"></i> è«–æ–‡ãƒ»è¨˜äº‹
                            </button>
                        </div>

                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Input Form -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">æƒ…å ±ã®å…¥åŠ›</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">è‘—è€…ãƒ»ä½œæˆè€…</label>
                                        <input type="text" oninput="updateCitationData('author', this.value)" value="${state.citationData.author}" placeholder="ä¾‹: å¤ç›® æ¼±çŸ³" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">
                                            ${state.citationType === 'web' ? 'Webãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«' : state.citationType === 'article' ? 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«' : 'æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«'}
                                        </label>
                                        <input type="text" oninput="updateCitationData('title', this.value)" value="${state.citationData.title}" placeholder="${state.citationType === 'web' ? 'ä¾‹: è‘—ä½œæ¨©ã®æ¦‚è¦' : 'ä¾‹: å¾è¼©ã¯çŒ«ã§ã‚ã‚‹'}" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                    </div>
                                    
                                    ${state.citationType !== 'web' ? `
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1">
                                                ${state.citationType === 'article' ? 'æ²è¼‰èªŒå' : 'å‡ºç‰ˆç¤¾'}
                                            </label>
                                            <input type="text" oninput="updateCitationData('publisher', this.value)" value="${state.citationData.publisher}" placeholder="${state.citationType === 'article' ? 'ä¾‹: å›½èªæ•™è‚²ç ”ç©¶' : 'ä¾‹: å²©æ³¢æ›¸åº—'}" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                        </div>
                                    ` : ''}

                                    ${state.citationType === 'web' ? `
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1">Webã‚µã‚¤ãƒˆåï¼ˆé‹å–¶å…ƒï¼‰</label>
                                            <input type="text" oninput="updateCitationData('publisher', this.value)" value="${state.citationData.publisher}" placeholder="ä¾‹: æ–‡åŒ–åºã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                        </div>
                                    ` : ''}

                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">ç™ºè¡Œå¹´ãƒ»å…¬é–‹å¹´</label>
                                        <input type="text" oninput="updateCitationData('year', this.value)" value="${state.citationData.year}" placeholder="ä¾‹: 2023" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                    </div>

                                    ${state.citationType === 'web' ? `
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1">URL</label>
                                            <input type="text" oninput="updateCitationData('url', this.value)" value="${state.citationData.url}" placeholder="https://..." class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1">é–²è¦§æ—¥ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ—¥ï¼‰</label>
                                            <input type="text" oninput="updateCitationData('accessDate', this.value)" value="${state.citationData.accessDate}" placeholder="ä¾‹: 2024-05-20" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Preview -->
                            <div class="space-y-6">
                                <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg relative">
                                    <h3 class="font-bold text-sm text-slate-400 mb-4 uppercase tracking-widest">Preview</h3>
                                    
                                    <div id="citation-preview" class="bg-slate-900 p-4 rounded font-mono text-sm leading-relaxed min-h-[100px] flex items-center">
                                        ${getFormattedCitation() || '<span class="text-slate-600">å·¦å´ã®ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>'}
                                    </div>

                                    <div class="mt-4 text-xs text-slate-400 flex items-start gap-2">
                                        <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                                        <p>
                                            å­¦æ ¡ã‚„å­¦ä¼šã«ã‚ˆã£ã¦ç´°ã‹ã„ãƒ«ãƒ¼ãƒ«ã®é•ã„ï¼ˆã‚«ãƒ³ãƒã®ä½ç½®ã‚„ã€ã€ã®ä½¿ã„æ–¹ãªã©ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚
                                            æå‡ºå…ˆã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                    <h4 class="font-bold text-green-800 mb-2 text-sm">æ›¸ãæ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</h4>
                                    <ul class="text-sm text-green-700 space-y-2 list-disc pl-4">
                                        ${state.citationType === 'book' ? `
                                            <li>è‘—è€…ãŒè¤‡æ•°ã®å ´åˆã¯ã€Œãƒ»ã€ã‚„ã€Œ,ã€ã§åŒºåˆ‡ã‚Šã¾ã™ã€‚</li>
                                            <li>ç‰ˆæ•°ï¼ˆç¬¬2ç‰ˆãªã©ï¼‰ãŒã‚ã‚‹å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã®å¾Œã«è¨˜è¿°ã—ã¾ã™ã€‚</li>
                                        ` : ''}
                                        ${state.citationType === 'web' ? `
                                            <li>Webã‚µã‚¤ãƒˆã¯å†…å®¹ãŒæ›¸ãæ›ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ã€Œé–²è¦§æ—¥ã€ãŒéå¸¸ã«é‡è¦ã§ã™ã€‚</li>
                                            <li>URLã¯é€”ä¸­ã§æ”¹è¡Œã›ãšã€ãƒªãƒ³ã‚¯ãŒåˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</li>
                                        ` : ''}
                                        ${state.citationType === 'article' ? `
                                            <li>è«–æ–‡ã®å ´åˆã¯ã€æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ã€Œå·»ãƒ»å·ã€ã¨ã€Œãƒšãƒ¼ã‚¸ç•ªå·ã€ãŒå¿…é ˆã§ã™ã€‚</li>
                                        ` : ''}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update DOM
            mainContent.innerHTML = html;

            // Initialize Lucide Icons for new content
            lucide.createIcons();
        }

        // Initial Render
        render();

    </script>
</body>
</html>
